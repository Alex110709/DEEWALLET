/**
 * DEE WALLET - Main Window Implementation
 */

#include "MainWindow.h"
#include "WelcomeScreen.h"
#include "WalletDetailScreen.h"
#include "ChainDetailScreen.h"
#include "LoadingScreen.h"
#include "../core/KeyfileManager.h"
#include <QVBoxLayout>
#include <QTimer>
#include <QMessageBox>
#include <QFile>
#include <QJsonDocument>
#include <QJsonObject>
#include <QApplication>
#include <QDebug>
#include <QtConcurrent>
#include <QFuture>
#include <QFutureWatcher>

MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
    , stackedWidget(new QStackedWidget(this))
    , welcomeScreen(nullptr)
    , walletDetailScreen(nullptr)
    , chainDetailScreen(nullptr)
    , loadingScreen(nullptr)
{
    setupUI();
    showWelcomeScreen();
}

MainWindow::~MainWindow()
{
}

void MainWindow::setupUI()
{
    setCentralWidget(stackedWidget);

    // Set window size
    setMinimumSize(1000, 650);
    resize(1200, 750);

    // Clean dark theme with solid background
    setStyleSheet(R"(
        QMainWindow {
            background-color: #0F172A;
        }
        QWidget {
            color: #E2E8F0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        QPushButton {
            background-color: #3B82F6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
        }
        QPushButton:hover {
            background-color: #2563EB;
        }
        QPushButton:pressed {
            background-color: #1D4ED8;
        }
        QPushButton#secondaryButton {
            background-color: #1E293B;
            color: #94A3B8;
            border: 1px solid #334155;
        }
        QPushButton#secondaryButton:hover {
            background-color: #334155;
            color: #CBD5E1;
        }
        QLineEdit {
            background-color: #1E293B;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 10px 14px;
            color: #E2E8F0;
            font-size: 14px;
            selection-background-color: #3B82F6;
        }
        QLineEdit:focus {
            border: 1px solid #3B82F6;
            background-color: #1E293B;
        }
        QLabel {
            color: #CBD5E1;
        }
    )");
}

void MainWindow::showWelcomeScreen()
{
    if (!welcomeScreen) {
        welcomeScreen = new WelcomeScreen(this);
        connect(welcomeScreen, &WelcomeScreen::walletCreated,
                this, &MainWindow::onWalletCreated);
        connect(welcomeScreen, &WelcomeScreen::walletImported,
                this, &MainWindow::onWalletImported);
        connect(welcomeScreen, &WelcomeScreen::loadingStarted,
                this, &MainWindow::onLoadingStarted);
        stackedWidget->addWidget(welcomeScreen);
    }

    stackedWidget->setCurrentWidget(welcomeScreen);
}

void MainWindow::showWalletScreen(const QString &mnemonic)
{
    if (!walletDetailScreen) {
        walletDetailScreen = new WalletDetailScreen(mnemonic, this);
        connect(walletDetailScreen, &WalletDetailScreen::backToWelcome,
                this, &MainWindow::onBackToWelcome);
        connect(walletDetailScreen, &WalletDetailScreen::chainClicked,
                this, &MainWindow::onChainClicked);
        stackedWidget->addWidget(walletDetailScreen);
    } else {
        // Update existing screen with new mnemonic
        walletDetailScreen->deleteLater();
        walletDetailScreen = new WalletDetailScreen(mnemonic, this);
        connect(walletDetailScreen, &WalletDetailScreen::backToWelcome,
                this, &MainWindow::onBackToWelcome);
        connect(walletDetailScreen, &WalletDetailScreen::chainClicked,
                this, &MainWindow::onChainClicked);
        stackedWidget->addWidget(walletDetailScreen);
    }

    currentMnemonic = mnemonic;
    stackedWidget->setCurrentWidget(walletDetailScreen);
}

void MainWindow::onWalletCreated(const QString &mnemonic)
{
    showWalletScreen(mnemonic);
}

void MainWindow::onWalletImported(const QString &mnemonic)
{
    showWalletScreen(mnemonic);
}

void MainWindow::onBackToWelcome()
{
    currentMnemonic.clear();
    showWelcomeScreen();
}

void MainWindow::onChainClicked(const QString &chainName, const QString &chainSymbol, const QString &mnemonic)
{
    showChainDetailScreen(chainName, chainSymbol, mnemonic);
}

void MainWindow::showChainDetailScreen(const QString &chainName, const QString &chainSymbol, const QString &mnemonic)
{
    if (chainDetailScreen) {
        chainDetailScreen->deleteLater();
    }
    
    chainDetailScreen = new ChainDetailScreen(chainName, chainSymbol, mnemonic, this);
    connect(chainDetailScreen, &ChainDetailScreen::backClicked,
            this, &MainWindow::onBackToWalletDetail);
    stackedWidget->addWidget(chainDetailScreen);
    stackedWidget->setCurrentWidget(chainDetailScreen);
}

void MainWindow::onBackToWalletDetail()
{
    if (walletDetailScreen) {
        stackedWidget->setCurrentWidget(walletDetailScreen);
    }
}

void MainWindow::onLoadingStarted(const QString &filepath, const QString &password)
{
    qDebug() << "[MainWindow] Loading started for:" << filepath;
    
    // Show loading screen
    if (!loadingScreen) {
        loadingScreen = new LoadingScreen(this);
        stackedWidget->addWidget(loadingScreen);
    }
    
    loadingScreen->setMessage("지갑 복호화 중...");
    loadingScreen->startAnimation();
    stackedWidget->setCurrentWidget(loadingScreen);
    
    // Force immediate UI update
    loadingScreen->repaint();
    QApplication::processEvents();
    
    qDebug() << "[MainWindow] Starting async decryption...";
    
    // Run decryption in background thread using QtConcurrent
    QFuture<QByteArray> future = QtConcurrent::run([filepath, password]() {
        qDebug() << "[MainWindow] Decryption running in background thread...";
        KeyfileManager keyfileManager;
        return keyfileManager.loadAndDecrypt(filepath, password);
    });
    
    // Watch for completion
    QFutureWatcher<QByteArray> *watcher = new QFutureWatcher<QByteArray>(this);
    connect(watcher, &QFutureWatcher<QByteArray>::finished, this, [this, watcher, filepath]() {
        QByteArray decrypted = watcher->result();
        watcher->deleteLater();
        
        qDebug() << "[MainWindow] Decryption complete. Size:" << decrypted.size();
        loadingScreen->stopAnimation();
        
        if (decrypted.isEmpty()) {
            qDebug() << "[MainWindow] Decryption failed - empty result";
            stackedWidget->setCurrentWidget(welcomeScreen);
            QMessageBox::critical(this, "오류", 
                QString("비밀번호가 틀렸거나 파일이 손상되었습니다.\n\n"
                        "파일: %1\n"
                        "파일 크기: %2 bytes")
                .arg(filepath)
                .arg(QFile(filepath).size()));
            return;
        }
        
        // Parse JSON to get mnemonic
        QJsonDocument doc = QJsonDocument::fromJson(decrypted);
        if (!doc.isObject()) {
            stackedWidget->setCurrentWidget(welcomeScreen);
            QMessageBox::critical(this, "오류", "키파일 형식이 올바르지 않습니다.");
            return;
        }
        
        QJsonObject obj = doc.object();
        QString mnemonic = obj["mnemonic"].toString();
        
        if (mnemonic.isEmpty()) {
            stackedWidget->setCurrentWidget(welcomeScreen);
            QMessageBox::critical(this, "오류", "복구 문구를 찾을 수 없습니다.");
            return;
        }
        
        // Success - show wallet screen
        showWalletScreen(mnemonic);
    });
    
    watcher->setFuture(future);
}

void MainWindow::processDecryption(const QString &filepath, const QString &password)
{
    qDebug() << "[MainWindow] Starting decryption...";
    
    // Try to decrypt keyfile
    KeyfileManager keyfileManager;
    QByteArray decrypted = keyfileManager.loadAndDecrypt(filepath, password);
    
    qDebug() << "[MainWindow] Decryption complete. Size:" << decrypted.size();
    
    loadingScreen->stopAnimation();
    
    if (decrypted.isEmpty()) {
        qDebug() << "[MainWindow] Decryption failed - empty result";
        stackedWidget->setCurrentWidget(welcomeScreen);
        QMessageBox::critical(this, "오류", 
            QString("비밀번호가 틀렸거나 파일이 손상되었습니다.\n\n"
                    "파일: %1\n"
                    "파일 크기: %2 bytes")
            .arg(filepath)
            .arg(QFile(filepath).size()));
        return;
    }
    
    // Parse JSON to get mnemonic
    QJsonDocument doc = QJsonDocument::fromJson(decrypted);
    if (!doc.isObject()) {
        stackedWidget->setCurrentWidget(welcomeScreen);
        QMessageBox::critical(this, "오류", "키파일 형식이 올바르지 않습니다.");
        return;
    }
    
    QJsonObject obj = doc.object();
    QString mnemonic = obj["mnemonic"].toString();
    
    if (mnemonic.isEmpty()) {
        stackedWidget->setCurrentWidget(welcomeScreen);
        QMessageBox::critical(this, "오류", "복구 문구를 찾을 수 없습니다.");
        return;
    }
    
    // Success - show wallet screen
    showWalletScreen(mnemonic);
}
